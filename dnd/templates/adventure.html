{% extends "master.html" %}

{% block title %}
Adventure
{% endblock %}

{% block content %}



<div class="card adventure">
    <p id="textAventure">Un ennemi surgit</p>

    <p id="skill"></p>
    <p id="target"></p>
    <p id="dice_roll"></p>
    <div id="result">Vous avez tiré un : <div id="resultDice"></div> <div id="modificateur"></div> <div id="finalResult"></div></div>
    <p id="winlose"></p>

    <button id="dice">Lancer le dé</button>

    <button id="suivant" style="display: none;">Suivant</button>

    <a href="#" id="terminer" style="display: none;">Terminer</a>
</div>

{% endblock %}

{% block scripts %}
<script type="text/python">
    from browser import document, window, ajax, console, bind

    skills = ["sagesse", "force", "dexterite", "charisme", "intelligence", "constitution"]

    def sleep(sec):
        def _sleep(resolve, reject):
            window.setTimeout(resolve, sec * 1000)
        return window.Promise.new(_sleep)

    def change_skill():
        random_skill = skills[window.Math.floor(window.Math.random() * len(skills))]
        document["skill"].text = f"Compétence testée : {random_skill}"

    def dice_roll_complete():
        interval_id = [None]

        def change_dice_roll():
            document["dice_roll"].text = f"Tu dois faire mieux que : {window.Math.floor(window.Math.random() * 20) + 1}"

        def stop_changing_dice_roll():
            window.clearInterval(interval_id[0])
            document["dice_roll"].text = f"Tu dois faire mieux que : {result['dice_target']}"

        def stop_changing_skill():
            window.clearInterval(interval_id[0])
            document["skill"].text = f"Compétence testée : {result['skill']}"
            interval_id[0] = window.setInterval(change_dice_roll, 100)
            sleep(3).then(lambda _: stop_changing_dice_roll())
            print(result['skill'])
            print(result['dice_target'])
            print(result['dice_roll'])

        interval_id[0] = window.setInterval(change_skill, 100)
        sleep(3).then(lambda _: stop_changing_skill())

    def display_info():
        def on_complete(req):
            if req.status == 200 or req.status == 0:
                global result
                result = window.JSON.parse(req.text)
                dice_roll_complete()

        req = ajax.ajax()
        req.bind('complete', on_complete)
        req.open('GET', '/roll_dice', True)
        req.send()

    display_info()

    def roll_dice():
        def change_dice():
            document["resultDice"].text = f"{window.Math.floor(window.Math.random() * 20) + 1}"
        
        def stop_changing_dice():
            window.clearInterval(interval_id[0])
            document["resultDice"].text = f"{result['dice_roll']}"
            document["modificateur"].text = f"{'+' if result['modificateur'] >= 0 else '-'}{abs(result['modificateur'])}"
            document["finalResult"].text = f"= {result['dice_roll'] + result['modificateur']}"
            document["winlose"].text = f"Vous avez {'gagné' if result['win'] else 'perdu'}"
            document["suivant"].style.display = "block"
            document["dice"].style.display = "none"
            if(result['end'] == True):
                document["terminer"].style.display = "block"
                document["suivant"].style.display = "none"

        interval_id = [None]
        interval_id[0] = window.setInterval(change_dice, 100)
        sleep(3).then(lambda _: stop_changing_dice())


    document["dice"].bind("click", lambda _: roll_dice())

    def next():
        document["suivant"].style.display = "none"
        document["textAventure"].text = ""
        document["skill"].text = ""
        document["target"].text = ""
        document["dice_roll"].text = ""
        document["resultDice"].text = ""
        document["modificateur"].text = ""
        document["finalResult"].text = ""
        document["winlose"].text = ""

        display_info()

    document["suivant"].bind("click", lambda _: next())

</script>

{% endblock %}